% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/OMNIBUS_test.R
\name{.magcat_get_fun}
\alias{.magcat_get_fun}
\title{MAGCAT omnibus pathway p-values (6-method framework; optional global + MVN calibration)}
\usage{
.magcat_get_fun(fname)
}
\arguments{
\item{gene_results}{A data.frame of gene-level results (typically one row per gene).
Must contain the gene identifier column specified by \code{gene_col} and at least one
p-value column (\code{p_raw_col} and/or \code{p_adj_col}). If you want Stouffer, it must
also contain \code{z_col}. If you want weighted Stouffer, it must contain \code{weight_col}.}

\item{pathways}{Pathway definitions. Either:
\itemize{
\item a data.frame with columns \code{pathway_id} and \code{gene_id} (and optional \code{pathway_name}), or
\item a named list where each element is a character vector of gene IDs (names are pathway IDs).
}
Provide \code{pathways} \strong{or} \code{species} (not both).}

\item{species}{Character. If \code{pathways} is \code{NULL}, a species keyword (e.g. \code{"maize"})
used to auto-load built-in pathway sets (e.g., PMN). Provide \code{species} \strong{or}
\code{pathways} (not both).}

\item{pmn_gene_col}{Character. When \code{species} is used, the name of the gene identifier column
in the built-in PMN pathway table (e.g., \code{"Gene-name"}). Ignored if \code{pathways} is provided.}

\item{gene_col}{Character. Column name in \code{gene_results} containing gene IDs.
Default \code{"GENE"}.}

\item{p_raw_col}{Character. Column name in \code{gene_results} containing raw gene-level p-values.
Default \code{"P"}.}

\item{p_adj_col}{Character or \code{NULL}. Optional column name for adjusted/preferred gene p-values.
If provided and present, this column is used for the p-based component methods (ACAT/Fisher/TFisher/minP).
If \code{NULL}, \code{p_raw_col} is used.}

\item{z_col}{Character or \code{NULL}. Optional column name in \code{gene_results} containing gene-level Z
statistics used for Stouffer. If \code{NULL}, Stouffer is not computed (set to \code{NA}).}

\item{weight_col}{Character or \code{NULL}. Optional column name in \code{gene_results} containing weights
for Stouffer (e.g., gene size or other reliability weights). If \code{NULL}, equal weights are used.}

\item{tau_grid}{Numeric vector of \eqn{\tau} values for adaptive soft TFisher. The method computes analytic
p-values for each \eqn{\tau} and selects the minimum. Default is a typical decreasing grid.}

\item{tau_cap}{Numeric. Maximum allowed \eqn{\tau} value (sanity bound). Default \code{1}.}

\item{min_p}{Numeric. Lower bound for p-value clipping to avoid numerical issues (e.g., \code{log(0)} in Fisher,
\code{tan()} blowups in ACAT). P-values are clipped to \code{[min_p, 1-min_p]}. Default \code{1e-15}.}

\item{min_genes}{Integer. Minimum number of genes required for a pathway to be evaluated. Pathways with fewer
genes are dropped. Default \code{2L}.}

\item{magma_out}{Optional data.frame of MAGMA competitive gene-set results. Must include \code{pathway_id} and
\code{magma_pvalue}. If \code{NULL}, MAGMA competitive is not included.}

\item{include_magma_in_omni}{Logical. If \code{TRUE} and \code{magma_out} is provided, include MAGMA competitive
p-values as an additional component in the omnibus across methods. Default \code{TRUE}.}

\item{include_magma_in_perm}{Logical. If \code{TRUE}, also include MAGMA competitive within the resampling null.
This is generally \strong{not recommended} because there is no cheap principled null generator for competitive
MAGMA; default \code{FALSE}.}

\item{omnibus}{Character. How to combine the component method p-values into one omnibus p-value per pathway:
\code{"ACAT"} (ACAT across methods) or \code{"minP"} (Sidak-adjusted minimum across methods).}

\item{B_perm}{Integer or \code{NULL}. Convenience parameter for the number of resampling iterations. When provided,
it is mapped to \code{B_global} and/or \code{B_mvn} according to \code{perm_mode}.}

\item{perm_mode}{Character. Which resampling/calibration mode to run for the omnibus:
\code{"none"} (analytic only), \code{"global"} (global gene resampling), \code{"mvn"} (LD-aware MVN resampling),
or \code{"both"} (run both; final p-value prefers MVN if available).}

\item{mvn_marginal}{Character. Only used when \code{perm_mode} includes \code{"mvn"}.
Controls how simulated MVN Z's are converted to p-values for p-based component methods:
\code{"uniform"} (Gaussian copula; Uniform(0,1) marginals) or \code{"empirical"} (map copula uniforms to an
empirical null p distribution).}

\item{mvn_pool}{Character. Only used when \code{mvn_marginal="empirical"} and \code{pool_p} is \code{NULL}.
Determines which gene-level p-values are used to construct the empirical null pool:
\code{"use"} (the p column used for observed p-based methods; typically \code{p_adj_col} if present) or
\code{"raw"} (\code{p_raw_col}).}

\item{pool_p}{Numeric vector or \code{NULL}. Optional explicit empirical null pool of p-values used when
\code{mvn_marginal="empirical"}. If \code{NULL}, an empirical pool is constructed automatically (excluding
pathway genes to reduce leakage).}

\item{B_global}{Integer. Number of global resampling iterations (back-compat / low-level control). Ignored if
\code{B_perm} is provided (then \code{B_perm} + \code{perm_mode} determine \code{B_global}).}

\item{B_mvn}{Integer. Number of MVN resampling iterations (back-compat / low-level control). Ignored if
\code{B_perm} is provided.}

\item{perm_pool}{Character. Only affects global resampling. Which p-value pool to resample from:
\code{"obs"} uses the same p-values used for observed p-based methods (typically \code{p_adj_col} if present),
while \code{"raw"} uses \code{p_raw_col}.}

\item{magma_cor_file}{Character or \code{NULL}. Path to a 3-column gene correlation pairs file:
\code{gene1 gene2 r}. Required for \code{perm_mode="mvn"} unless \code{magma_cor_pairs} is provided.}

\item{magma_cor_pairs}{data.frame or \code{NULL}. In-memory correlation pairs table with columns
\code{gene1}, \code{gene2}, \code{r}. If provided, it overrides \code{magma_cor_file}.}

\item{make_PD}{Logical. If \code{TRUE}, force the pathway correlation matrix \eqn{R_S} to be positive definite
(using \code{Matrix::nearPD()}) before Cholesky. Strongly recommended. Default \code{TRUE}.}

\item{seed}{Integer or \code{NULL}. Random seed for reproducible resampling.}

\item{output}{Logical. If \code{TRUE}, write results to CSV in \code{out_dir} and attach the file path as an attribute.}

\item{out_dir}{Character. Output directory used when \code{output=TRUE}. Created if it does not exist.}
}
\value{
A data.frame with one row per pathway, including:
\itemize{
\item \code{acat_p}, \code{fisher_p}, \code{tfisher_p_analytic}, \code{minp_p_analytic}, \code{stouffer_p_analytic}
\item \code{magma_pvalue} (if provided)
\item \code{omni_p_analytic} and BH-adjusted version
\item \code{omni_p_global} (if global resampling run) and BH-adjusted version
\item \code{omni_p_mvn} (if MVN resampling run) and BH-adjusted version
\item \code{omni_p_final} (priority: MVN > global > analytic) and BH-adjusted version
}
}
\description{
Computes pathway-level p-values from gene-level statistics using up to six component
methods and combines them into a single omnibus p-value per pathway. Optionally,
calibrates the omnibus p-values using either (i) global gene resampling or (ii)
LD-aware MVN resampling based on MAGMA gene–gene correlations.
}
\details{
\strong{Component methods (per pathway):}
\enumerate{
\item \strong{ACAT (gene-level):} ACAT combine of gene p-values in the pathway.
\item \strong{Fisher (gene-level):} Fisher's method on gene p-values in the pathway.
\item \strong{Adaptive soft TFisher (gene-level):} For each \code{tau} in \code{tau_grid},
computes \code{TFisher::stat.soft()} and its analytic p-value via \code{TFisher::p.soft()},
then takes the minimum p-value over \code{tau_grid}.
\item \strong{minP (gene-level):} Sidak-adjusted minimum gene p-value in the pathway.
\item \strong{Stouffer Z (gene-level):} Stouffer combination of gene Z-scores (optionally weighted).
\item \strong{MAGMA competitive (optional):} Uses your precomputed MAGMA competitive
gene-set p-value (provided via \code{magma_out}).
}

\strong{Omnibus across methods (per pathway):}
Combines the component method p-values using either:
\itemize{
\item \code{omnibus="ACAT"}: ACAT across method p-values, or
\item \code{omnibus="minP"}: Sidak-adjusted minP across method p-values.
}

\strong{Resampling / calibration (omnibus only):}
\itemize{
\item \code{perm_mode="global"}: resamples gene p-values (and optionally Z's) from a global pool
to build a null distribution of the omnibus statistic.
\item \code{perm_mode="mvn"}: simulates correlated gene Z's
\eqn{Z \sim \mathcal{N}(0, R_S)} using a pathway-specific correlation matrix \eqn{R_S}
built from MAGMA gene–gene correlations. P-values for p-based methods are derived from the
simulated Z's.
}

\strong{MVN p-value marginals:}
When \code{perm_mode} includes \code{"mvn"}, p-values for p-based component methods are obtained from
the simulated MVN Z's in one of two ways:
\itemize{
\item \code{mvn_marginal="uniform"} (recommended): Gaussian-copula mapping
\eqn{U=\Phi(Z)}, \eqn{p=2\min(U,1-U)} so each marginal is Uniform(0,1).
\item \code{mvn_marginal="empirical"} (advanced): Gaussian copula for dependence, but map
\eqn{U=\Phi(Z)} to an empirical null p-value distribution \eqn{F_0^{-1}(U)} derived from
\code{pool_p} (or an automatically constructed pool).
}
}
