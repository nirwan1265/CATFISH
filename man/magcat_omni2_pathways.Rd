% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/OMNIBUS_test.R
\name{magcat_omni2_pathways}
\alias{magcat_omni2_pathways}
\title{MAGCAT omnibus pathway p-values (6-method framework; optional global + MVN calibration)}
\usage{
magcat_omni2_pathways(
  gene_results,
  pathways = NULL,
  species = NULL,
  pmn_gene_col = NULL,
  gene_col = "GENE",
  p_raw_col = "P",
  p_adj_col = NULL,
  z_col = NULL,
  weight_col = NULL,
  tau_grid = c(0.2, 0.1, 0.05, 0.02, 0.01, 0.005, 0.001),
  tau_cap = 1,
  min_p = 1e-15,
  min_genes = 2L,
  do_fix = TRUE,
  stouffer_min_abs_w = 1e-08,
  stouffer_alternative = c("greater", "two.sided", "less"),
  magma_out = NULL,
  include_magma_in_omni = TRUE,
  include_magma_in_perm = FALSE,
  omnibus = c("ACAT", "minP"),
  B_perm = NULL,
  perm_mode = c("none", "global", "mvn", "both"),
  mvn_marginal = c("uniform", "empirical"),
  mvn_pool = c("use", "raw"),
  pool_p = NULL,
  mvn_calibrate_components = FALSE,
  B_global = 0L,
  B_mvn = 0L,
  perm_pool = c("raw", "obs"),
  magma_cor_file = NULL,
  magma_cor_pairs = NULL,
  make_PD = TRUE,
  seed = NULL,
  output = FALSE,
  out_dir = "magcat_omni2"
)
}
\arguments{
\item{gene_results}{data.frame of gene-level results (one row per gene recommended).
Must contain \code{gene_col} and at least one p-value column (\code{p_raw_col} and/or \code{p_adj_col}).
If you want Stouffer, it must contain \code{z_col}. If you want weighted Stouffer, it must contain
\code{weight_col}.}

\item{pathways}{Pathway definitions (provide \code{pathways} OR \code{species}).
Either a data.frame with columns \code{pathway_id}, \code{gene_id} (optional \code{pathway_name}),
or a named list mapping \code{pathway_id -> character vector of genes}.}

\item{species}{Optional character (provide \code{species} OR \code{pathways}), one of
\code{"maize"}, \code{"sorghum"}, \code{"arabidopsis"}, \code{"plant"}.
When provided, pathways are loaded via \code{magcat_load_pathways()}.}

\item{pmn_gene_col}{Optional character. When \code{species} is used, passed to
\code{magcat_load_pathways(species=..., gene_col=pmn_gene_col)}.}

\item{gene_col}{Character. Gene ID column in \code{gene_results}. Default \code{"GENE"}.}

\item{p_raw_col}{Character. Raw p-value column in \code{gene_results}. Default \code{"P"}.}

\item{p_adj_col}{Character or NULL. Preferred/adjusted p-value column. If supplied and present, used
for ACAT/Fisher/TFisher/minP. Default NULL.}

\item{z_col}{Character or NULL. Gene Z column for Stouffer. If NULL, Stouffer is skipped. Default NULL.}

\item{weight_col}{Character or NULL. Optional weights for Stouffer. Default NULL (equal weights).}

\item{tau_grid}{Numeric vector of \eqn{\tau} values for adaptive soft TFisher. Default is a typical grid.}

\item{tau_cap}{Numeric. Upper bound for \code{tau_grid} (sanity bound). Default 1.}

\item{min_p}{Numeric. P-values are clipped to \code{[min_p, 1-min_p]} to avoid numeric issues. Default 1e-15.}

\item{min_genes}{Integer. Minimum genes required per pathway. Default 2.}

\item{do_fix}{Logical. If TRUE, uses your \code{fix_p_for_acat()} if available (else clips). Default TRUE.}

\item{stouffer_min_abs_w}{Numeric. Non-finite / <=0 Stouffer weights replaced by this. Default 1e-8.}

\item{stouffer_alternative}{One of \code{"greater"}, \code{"two.sided"}, \code{"less"} for Stouffer. Default "greater".}

\item{magma_out}{Optional data.frame of MAGMA competitive results with columns \code{pathway_id}, \code{magma_pvalue}.}

\item{include_magma_in_omni}{Logical. Include MAGMA p-values as a component in the omnibus (if provided). Default TRUE.}

\item{include_magma_in_perm}{Logical. Include MAGMA p-values inside the resampling null. Generally not recommended.
If FALSE and permutations are run, MAGMA is omitted from the permuted omnibus. Default FALSE.}

\item{omnibus}{Character. \code{"ACAT"} or \code{"minP"} for combining method p-values. Default \code{"ACAT"}.}

\item{B_perm}{Integer or NULL. Convenience parameter for number of resampling iterations. If provided,
it overrides \code{B_global}/\code{B_mvn} according to \code{perm_mode}.}

\item{perm_mode}{Character. One of \code{"none"}, \code{"global"}, \code{"mvn"}, \code{"both"}.}

\item{mvn_marginal}{Character. Only for MVN mode: \code{"uniform"} or \code{"empirical"}.}

\item{mvn_pool}{Character. Only for MVN + empirical mode when \code{pool_p} is NULL.
\code{"use"} uses the same p-values used for observed p-based methods; \code{"raw"} prefers \code{p_raw_col}.
(If raw p-values are unavailable, falls back to \code{"use"}.)}

\item{pool_p}{Optional numeric vector of p-values to define the empirical null pool (advanced).
If supplied, it is used directly (no per-pathway exclusion).}

\item{mvn_calibrate_components}{Logical. If TRUE, MVN-calibrates each component first, then builds the omnibus
(and calibrates that omnibus). Default FALSE.}

\item{B_global}{Integer. Number of global-resampling iterations (used when \code{B_perm} is NULL).}

\item{B_mvn}{Integer. Number of MVN iterations (used when \code{B_perm} is NULL).}

\item{perm_pool}{Character. For global resampling only: \code{"raw"} (use raw p-values) or \code{"obs"} (use p used by methods).}

\item{magma_cor_file}{Character or NULL. Path to 3-col correlation pairs file: \code{gene1 gene2 r}.
Required for MVN unless \code{magma_cor_pairs} is provided.}

\item{magma_cor_pairs}{data.frame or NULL. In-memory correlation pairs with columns \code{gene1}, \code{gene2}, \code{r}.}

\item{make_PD}{Logical. If TRUE, forces correlation matrices to be positive definite before Cholesky. Default TRUE.}

\item{seed}{Integer or NULL. Random seed.}

\item{output}{Logical. If TRUE, writes CSV to \code{out_dir} and attaches \code{"file"} attribute. Default FALSE.}

\item{out_dir}{Character. Output directory. Default \code{"magcat_omni2"}.}
}
\value{
data.frame with one row per pathway, including:
\itemize{
\item component p-values (analytic): \code{acat_p}, \code{fisher_p}, \code{tfisher_p_analytic}, \code{minp_p_analytic}, \code{stouffer_p_analytic}
\item optional \code{magma_pvalue}
\item \code{omni_p_analytic}, \code{omni_p_global}, \code{omni_p_mvn}, and \code{omni_p_final} (+ BH/qvalue extras if you kept them in \code{magcat_omni2_run})
}
}
\description{
Compute pathway-level p-values from gene-level results using up to six component
methods (ACAT, Fisher, adaptive soft TFisher, minP, Stouffer Z, optional MAGMA
competitive) and combine them into a single omnibus p-value per pathway.
}
\details{
Resampling / calibration is applied \strong{only to the omnibus} (not to each component),
using either:
\itemize{
\item \strong{Global resampling} (fast heuristic): resample genes from a global pool.
\item \strong{MVN resampling} (LD-aware): simulate \eqn{Z \sim N(0, R_S)} using pathway-specific
geneâ€“gene correlation matrices built from MAGMA correlation pairs, then convert simulated
Z's into p-values for p-based methods.
}

\strong{Component methods per pathway}
\enumerate{
\item \strong{ACAT:} ACAT combine of gene p-values.
\item \strong{Fisher:} Fisher's method on gene p-values.
\item \strong{Adaptive soft TFisher:} computes analytic p-values on a \code{tau_grid} and takes the minimum.
\item \strong{minP:} Sidak-adjusted minimum gene p-value.
\item \strong{Stouffer Z:} combines gene Z's (optionally weighted; supports \code{alternative}).
\item \strong{MAGMA competitive (optional):} uses precomputed competitive gene-set p-values you provide.
}

\strong{Omnibus across methods per pathway}
\itemize{
\item \code{omnibus="ACAT"}: ACAT across method p-values, or
\item \code{omnibus="minP"}: Sidak-adjusted minP across method p-values.
}

\strong{Which gene-level p-values are used?}
P-based methods use \code{p_adj_col} if you provide it \emph{and} it exists in \code{gene_results};
otherwise they use \code{p_raw_col}.

\strong{MVN marginal mapping (only when \code{perm_mode} includes \code{"mvn"})}
\itemize{
\item \code{mvn_marginal="uniform"} (recommended): Gaussian-copula mapping
\eqn{U=\Phi(Z)}, \eqn{p=2\min(U,1-U)} so each marginal is Uniform(0,1).
\item \code{mvn_marginal="empirical"}: maps copula uniforms to an empirical null p distribution
derived internally from gene-level p-values (excluding the pathway's own genes to reduce leakage),
unless you supply \code{pool_p}.
}
}
\examples{
\dontrun{
# Load gene results from MAGMA output
gene_results <- read.delim("magma_output.genes.out")

# Run omnibus test with analytic p-values only (no permutation)
omni_res <- magcat_omni2_pathways(
  gene_results = gene_results,
  species = "maize",
  gene_col = "GENE",
  p_raw_col = "P",
  z_col = "ZSTAT",
  perm_mode = "none"
)
head(omni_res)

# With MVN-based calibration (requires gene-gene correlations)
omni_mvn <- magcat_omni2_pathways(
  gene_results = gene_results,
  species = "maize",
  perm_mode = "mvn",
  B_perm = 10000,
  magma_cor_file = "magma_output.genes.raw"
)

# With global resampling
omni_global <- magcat_omni2_pathways(
  gene_results = gene_results,
  species = "maize",
  perm_mode = "global",
  B_perm = 5000
)
}

}
\seealso{
\code{\link{magcat_acat_pathways}}, \code{\link{magcat_fisher_pathways}},
\code{\link{magcat_minp_pathways}}, \code{\link{magcat_stoufferZ_pathways}}
}
